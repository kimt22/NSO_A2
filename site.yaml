---
- hosts: all
  vars:
    ansible_ssh_common_args: '-o ProxyCommand="ssh -W %h:%p -q ubuntu@bastionNSO"'

- name: Configure Servers
  hosts: bastionNSO
  become: yes
  tasks:
    - name: Retrieve IP addresses of instances
      debug:
        msg: "The IP address of {{ item }} is {{ hostvars[item].ansible_default_ipv4.address }}"
        with_items: "{{ groups['webservers'] }}"

- name: Deploy HAproxy
  hosts: HAproxy
  become: yes
  become_method: sudo
  tasks:
    - name: Update APT cache
      apt:
        update_cache: yes

    - name: Install HAproxy
      apt:
        name: haproxy
        state: latest

    - name: Copy HAproxy configuration
      template:
        src: haproxy.cfg.j2
        dest: /etc/haproxy/haproxy.cfg

    - name: Restart HAproxy
      service:
        name: haproxy
        state: restarted
        enabled: yes

- name: Configure web servers
  hosts: webservers
  become: yes
  become_method: sudo
  tasks:
    - name: Update APT cache
      apt:
        update_cache: yes

    - name: Install Python packages
      apt:
        name:
          - python3
          - python3-pip
          - python3-flask
          - gunicorn
        state: latest

    - name: Install Flask
      pip:
        name: flask
        state: latest

    - name: Copy application file
      copy:
        src: application2.py
        dest: /home/ubuntu/application2.py
        mode: 0644

    - name: Start Flask app
      shell: gunicorn -w 2 -D -b 0.0.0.0:8080 application2:app

- name: Testing
  hosts: HAproxy
  become: yes
  tasks:
    - name: Testing the HAproxy load balancing 1st time.
      shell: "curl localhost"
      register: "output"
      args:
        warn: false
    - debug: var=output.stdout

    - name: Testing the HAproxy load balancing 2nd time.
      shell: "curl localhost"
      register: "output"
      args:
        warn: false
    - debug: var=output.stdout

    - name: Testing the HAproxy load balancing 3rd time.
      shell: "curl localhost"
      register: "output"
      args:
        warn: false
    - debug: var=output.stdout

